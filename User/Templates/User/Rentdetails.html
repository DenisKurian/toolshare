{% extends 'User/base.html' %}
{% block content %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
   
  <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.css"/>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick-theme.min.css"/>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@glidejs/glide"></script>
    <script src="https://cdn.jsdelivr.net/npm/@glidejs/glide"></script>
<style>
      * {box-sizing:border-box}

/* Slideshow container */
.slideshow-container {
  max-width: 1000px;
  position: relative;
  margin: auto;
}

/* Hide the images by default */
.mySlides {
  display: none;
}

/* Next & previous buttons */
.prev, .next {
  cursor: pointer;
  position: absolute;
  top: 50%;
  width: auto;
  margin-top: -22px;
  padding: 16px;
  color: white;
  font-weight: bold;
  font-size: 18px;
  transition: 0.6s ease;
  border-radius: 0 3px 3px 0;
  user-select: none;
}

/* Position the "next button" to the right */
.next {
  right: 0;
  border-radius: 3px 0 0 3px;
}

/* On hover, add a black background color with a little bit see-through */
.prev:hover, .next:hover {
  background-color: rgba(0,0,0,0.8);
}

/* Caption text */
.text {
  color: #f2f2f2;
  font-size: 15px;
  padding: 8px 12px;
  position: absolute;
  bottom: 8px;
  width: 100%;
  text-align: center;
}

/* Number text (1/3 etc) */
.numbertext {
  color: #f2f2f2;
  font-size: 12px;
  padding: 8px 12px;
  position: absolute;
  top: 0;
}

/* The dots/bullets/indicators */
.dot {
  cursor: pointer;
  height: 15px;
  width: 15px;
  margin: 0 2px;
  background-color: #bbb;
  border-radius: 50%;
  display: inline-block;
  transition: background-color 0.6s ease;
}

.active, .dot:hover {
  background-color: #717171;
}

/* Fading animation */
.fade {
  animation-name: fade;
  animation-duration: 1.5s;
}

@keyframes fade {
  from {opacity: .4}
  to {opacity: 1}
}

    </style>
        <style>
            .card-header {
                display: flex;
                justify-content: space-between;

            }
        </style>
    </head>
    <style>
        
        .form-container {
          display: flex;
          flex-direction: column;
          align-items: center;
          margin-top: 20px;
        }
    
        .form-group {
          display: flex;
          flex-direction: column;
          align-items: flex-start;
          margin-bottom: 15px;
          width: 100%;
        }
    
        .form-group label {
          margin-bottom: 5px;
          font-weight: bold;
        }
    
        .form-group input {
          width: 100%;
          padding: 10px;
          border: 1px solid #ccc;
          border-radius: 5px;
        }
    
        .form-group input:focus {
          border-color: #007bff;
          outline: none;
        }
    
        .form-group input[readonly] {
          background-color: #f9f9f9;
        }
    
        .btn-submit {
          padding: 10px 20px;
          font-size: 16px;
          font-weight: bold;
          color: white;
          background-color: #007bff;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          transition: background-color 0.3s ease;
        }
    
        .btn-submit:hover {
        
          transform: scale(1.05);
        }

        .hero-section {
  position: relative;
  text-align: relative;
  background-image: url('{{ data.gallery_file.url }}'), linear-gradient(to bottom, #CAD1E4, #CAD1E4 1000%) ;
  background-blend-mode: luminosity;
  background-size: max(50%, 100%);
  background-repeat: no-repeat;
    background-position: center;
  
  color: white;
  height: 400px; /* Adjust height as needed */
  z-index: -1;
  backdrop-filter: blur(5px);
  background-attachment: fixed;
  
}
.hero-section::after {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(to bottom, rgba(255, 255, 255, 0) 0%, #CAD1E4 100%);
  z-index: -1;
  backdrop-filter: blur(1px);
}

.back-button {
  position: absolute;
  align-self: self-start;
  z-index: 1;
}
.back-button:hover {
  transition: scale(1.05);
}
.card {

box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
background-color: transparent;
-webkit-backdrop-filter: blur(8px);
backdrop-filter: blur(8px);
height: auto;
}
.error-message {
            color: red;
            display: none;
            font-size: 0.9em;
        }
        .availability-message {
            color: green;
            display: none;
            font-size: 0.9em;
        }
        table {
            width: 50%;
            margin: 20px auto;
        }
        td {
            padding: 10px;
        }
        .disabled-input {
            background-color: #f0f0f0;
            cursor: not-allowed;
        }


      </style>
<head>
    <title>Rent details</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>
<a id="back-button" class="back-button">&#x2B05; Back</a>
<section class="hero-section parallax">

      
    
  
    <div class="container container--narrow">
      
      
        
        
      
    </div>
  </section>
<body>
    
    
        <!-- Main Section -->
        <main class="renttool my-md">
          <div class="container">
            <div class="layout">
                <div class="column column--1of3">
                    <h3 class="devInfo__title">Rent Details : </h3>
                    <div class="card text-center">
                        <div class="card__body dev">
                          {% if error %}
                          <p style="color: red; text-align: center;">{{ error }}</p>
                      {% endif %}

                            <form method="post" class="form-container" id="rentForm">
                                {% csrf_token %}
                                <div class="form-group">
                                  <input type="text" name="from_date" id="from_date" 
                                      placeholder="Select From Date">
                                <span id="from_error" class="error-message">Invalid date selection</span>
                                </div>
                                <div class="form-group">
                                  <input type="text" name="to_date" id="to_date" 
                                    placeholder="Select To Date" class="disabled-input" disabled>
                                  <span id="to_error" class="error-message">Invalid date selection</span>
                                </div>
                                <div class="form-group">
                                  <label for="txtquantity">Quantity (Max: {{ total_qty }}):</label>
                                  <input type="number" name="txtquantity" id="txtquantity" min="1" max="{{ total_qty }}" value="1" onchange="validateDates(); getAmount();" required>
                                  <span id="qty_error" class="error-message"></span>
                                  <span id="qty_available" class="availability-message"></span>
                              </div>
                              <div class="form-group">
                                <label for="txtamount">Deposit Amount:</label>
                                <input type="text" name="txtdeposit2" id="txtdeposit2" readonly value="{{ deposit }}">
                              </div>
                                <div class="form-group">
                                  <label for="txtamount">Amount:</label>
                                  <input type="text" name="txtamount" id="txtamount" readonly>
                    <input type="hidden" name="txtamountperday" value="{{ amount }}" id="txtamountperday">
                    <input type="hidden" name="txtdeposit" value="{{ deposit }}" id="txtdeposit">
                                </div>
                                <input type="submit" name="btnsubmit" value="&#128179; Make Payment" id="submitBtn" class="btn-submit" disabled>
                              </form>
                              {{ booked_ranges|json_script:"booked-ranges" }}
                        </div>
                    </div>
                    <h3 class="devInfo__title">Owner Details : </h3>
                   
                    <div class="card text-center">
                        <div class="card__body dev">
                            <div class="dev__details">
                                <p class="dev__name">{{ data.user.user_name }}</p>
                                <!-- <a class="btn--spaced" href="{% url 'User:chatpage' data.user.id %}">&#128172; Chat</a> -->
                                <p class="dev__email">{{ data.user.email }}</p>
                                <p class="dev__phone">{{ data.user.phone }}</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="column column--2of3">
                    <div class="card text-center parallax">
                      <div class="card__body dev">
                        <h2 class="dev__name">{{ data.tool_name }}</h2>
                        <p class="dev__details">{{ data.tool_details }}</p>
                        <p class="dev__price">Price per day: {{ amount }}</p>
                        <div>
                          <p class="owner_contact">Contact: {{ data.user.user_contact }}</p>
                          <p class="owner_contact">Location: {{ data.user.location_name }}, {{ user.user_latitude }}, {{ user.user_longitude }}</p>
                  
                        </div>
                      </div>
                    </div>
                    <h3 class="devInfo__title">Gallery : </h3>
            
                  <div class="slideshow-container">
                    {% if gallery_images|length == 0 %}
                        <h3 class="devInfo__title text-center">No Images Uploaded</h3>
                      {% endif %}
                    {% for image in gallery_images %}

                    <!-- Full-width images with number and caption text -->
                    <div class="mySlides fade">
                      <div class="numbertext">{{ forloop.counter }} / {{ gallery_images|length }}</div>
                      <img src="{{ image.gallery_image.url }}" style="width:100%">
                      <div class="text">{{ forloop.counter }}</div>
                      

                    </div>
                    

                    {% endfor %}
                  
                    
                  
                    
                  
                    <!-- Next and previous buttons -->
                    <a class="prev" onclick="plusSlides(-1)">&#10094;</a>
                    <a class="next" onclick="plusSlides(1)">&#10095;</a>
                  </div>
                  <br>
                  
                  <!-- The dots/circles -->
                  <div style="text-align:center">
                    <span class="dot" onclick="currentSlide(1)"></span>
                    <span class="dot" onclick="currentSlide(2)"></span>
                    <span class="dot" onclick="currentSlide(3)"></span>
                  </div>
                  <div class="card text-center">
                    <div class="card__body">

              <div class="comments">
                {% if rating_count > 0 %}
                    <p class="rating">Ratings</p>
                    <h1><b><span class="rating-text">{{ average_rating|floatformat:0 }}</span> / 5</b></h1>
                    <div class="mb-3">
                        {% for k in "12345" %}
                            {% if forloop.counter0 < average_rating %}
                                <i class="fas fa-star text-warning"></i>
                            {% else %}
                                <i class="fas fa-star star-light"></i>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <h3><span class="revcount">{{ rating_count }}</span> Review(s)</h3>
                {% else %}
                    <p class="rating">Rating</p>
                    <h1><b><span class="rating-text">0</span> / 5</b></h1>
                    <div class="mb-3">
                        {% for k in "12345" %}
                            <i class="fas fa-star star-light"></i>
                        {% endfor %}
                    </div>
                    <h3><span class="revcount">No reviews yet</span></h3>
                {% endif %}
                
                <div class="commentList">
                    {% for rating in ratings %}
                    <div class="comment">
                      {% if rating.user.user_photo and rating.user.user_photo.url %}
                      <img class="avatar avatar--md" src="{{ rating.user.user_photo.url }}" alt="User Photo" />
                    {% else %}
                      <img class="avatar avatar--md" src="{% static 'staticfiles/images/profiles/user-default.png' %}" alt="Default User Photo" />
                    {% endif %}
                        <div class="comment__details">
                            <a href="rating.html" class="comment__author">{{ rating.user.user_name }}</a>
                            <p class="comment__info">
                                {{ rating.rating_review }}
                            </p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
              </div>
                
            </div>
            <!--  -->
            </div>
          </div>

        </main>
</body>

</html>

    <script>
        const bookedRanges = JSON.parse(document.getElementById("booked-ranges").textContent);
        const totalQty = {{ total_qty|default:1 }};

        // Calculate booked quantity for a specific date
        function getBookedQtyForDate(date) {
            const checkDate = new Date(date);
            let bookedQty = 0;
            bookedRanges.forEach(range => {
                const fromDate = new Date(range.from);
                const toDate = new Date(range.to);
                if (checkDate >= fromDate && checkDate <= toDate) {
                    bookedQty += parseInt(range.qty);
                }
            });
            return bookedQty;
        }

        // Generate array of fully booked dates (where available qty = 0)
        function getFullyBookedDates() {
            const fullyBookedDates = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize to start of day
            const endDate = new Date(today);
            endDate.setFullYear(today.getFullYear() + 1); // Check 1 year ahead

            // First, mark all dates within booked ranges where qty exceeds totalQty
            bookedRanges.forEach(range => {
                const fromDate = new Date(range.from);
                const toDate = new Date(range.to);
                let currentDate = new Date(fromDate);
                while (currentDate <= toDate) {
                    const bookedQty = getBookedQtyForDate(currentDate);
                    if (bookedQty >= totalQty) {
                        const dateStr = currentDate.toISOString().split('T')[0];
                        if (!fullyBookedDates.includes(dateStr)) {
                            fullyBookedDates.push(dateStr);
                        }
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            });

            return fullyBookedDates;
        }

        const fullyBookedDates = getFullyBookedDates();

        // Initialize Flatpickr for From Date
        const fromPicker = flatpickr("#from_date", {
            minDate: "today",
            dateFormat: "Y-m-d",
            disable: fullyBookedDates,
            onChange: function(selectedDates, dateStr) {
                const toDateInput = document.getElementById("to_date");
                if (dateStr) {
                    toDateInput.disabled = false;
                    toDateInput.classList.remove("disabled-input");
                    toPicker.set("minDate", dateStr);
                    toPicker.set("disable", fullyBookedDates.filter(d => new Date(d) >= new Date(dateStr)));
                    validateDates();
                    getAmount();
                } else {
                    toDateInput.disabled = true;
                    toDateInput.classList.add("disabled-input");
                    toPicker.clear();
                }
            }
        });

        // Initialize Flatpickr for To Date
        const toPicker = flatpickr("#to_date", {
            minDate: "today",
            dateFormat: "Y-m-d",
            disable: fullyBookedDates,
            onChange: function(selectedDates, dateStr) {
                validateDates();
                getAmount();
            }
        });

        // Validate dates and adjust quantity
        function validateDates() {
            const fromDate = document.getElementById("from_date").value;
            const toDate = document.getElementById("to_date").value;
            const qtyInput = document.getElementById("txtquantity");
            const qtyRequested = parseInt(qtyInput.value);
            const fromError = document.getElementById("from_error");
            const toError = document.getElementById("to_error");
            const qtyError = document.getElementById("qty_error");
            const qtyAvailableMsg = document.getElementById("qty_available");
            const submitBtn = document.getElementById("submitBtn");

            let isValid = true;
            let minAvailableQty = totalQty;

            // Reset messages
            fromError.style.display = "none";
            toError.style.display = "none";
            qtyError.style.display = "none";
            qtyAvailableMsg.style.display = "none";
            submitBtn.disabled = true;

            if (fromDate && toDate) {
                const start = new Date(fromDate);
                const end = new Date(toDate);

                if (start > end) {
                    toError.textContent = "To date must be after From date";
                    toError.style.display = "block";
                    isValid = false;
                } else {
                    let currentDate = new Date(start);
                    while (currentDate <= end) {
                        const bookedQty = getBookedQtyForDate(currentDate);
                        const availableQty = totalQty - bookedQty;
                        minAvailableQty = Math.min(minAvailableQty, availableQty);
                        if (availableQty === 0) {
                            qtyError.textContent = "No units available for selected dates";
                            qtyError.style.display = "block";
                            isValid = false;
                            break;
                        }
                        currentDate.setDate(currentDate.getDate() + 1);
                    }

                    qtyInput.max = minAvailableQty;
                    if (qtyRequested > minAvailableQty) {
                        qtyInput.value = minAvailableQty;
                    }
                    qtyAvailableMsg.textContent = `Available: ${minAvailableQty} units`;
                    qtyAvailableMsg.style.display = "block";
                }
            }

            submitBtn.disabled = !isValid || minAvailableQty === 0;
            return isValid && minAvailableQty > 0;
        }

        // Calculate total amount
        function getAmount() {
            if (!validateDates()) {
                document.getElementById("txtamount").value = "";
                return;
            }

            const amountPerDay = parseFloat(document.getElementById("txtamountperday").value);
            const deposit = parseInt(document.getElementById("txtdeposit").value);
            const fromDate = document.getElementById("from_date").value;
            const toDate = document.getElementById("to_date").value;
            const qty = parseInt(document.getElementById("txtquantity").value);

            if (fromDate && toDate) {
                const startDate = new Date(fromDate);
                const endDate = new Date(toDate);
                const diffInDays = Math.max((endDate - startDate) / (1000 * 3600 * 24) + 1, 1);

                const total = (diffInDays * amountPerDay * qty)+deposit;
                document.getElementById("txtamount").value = total.toFixed(2);
            }
        }

        // Trigger validation on quantity change
        document.getElementById("txtquantity").addEventListener("change", function() {
            const qtyInput = document.getElementById("txtquantity");
            const minAvailableQty = parseInt(qtyInput.max);
            if (parseInt(qtyInput.value) > minAvailableQty) {
                qtyInput.value = minAvailableQty;
            }
            validateDates();
            getAmount();
        });
    </script>
<script>
  let slideIndex = 1;
showSlides(slideIndex);

// Next/previous controls
function plusSlides(n) {
  showSlides(slideIndex += n);
}

// Thumbnail image controls
function currentSlide(n) {
  showSlides(slideIndex = n);
}

function showSlides(n) {
  let i;
  let slides = document.getElementsByClassName("mySlides");
  let dots = document.getElementsByClassName("dot");
  if (n > slides.length) {slideIndex = 1}
  if (n < 1) {slideIndex = slides.length}
  for (i = 0; i < slides.length; i++) {
    slides[i].style.display = "none";
  }
  for (i = 0; i < dots.length; i++) {
    dots[i].className = dots[i].className.replace(" active", "");
  }
  slides[slideIndex-1].style.display = "block";
  dots[slideIndex-1].className += " active";
}
</script>
<script>
  document.getElementById('back-button').addEventListener('click', function() {
      window.history.back();
  });
</script>
{% endblock %}